<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.22">
<title>CN tutorial</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f0f3f3; }
pre.pygments .tok-c { color: #0099FF; font-style: italic } /* Comment */
pre.pygments .tok-err { color: #AA0000; background-color: #FFAAAA } /* Error */
pre.pygments .tok-k { color: #006699; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #555555 } /* Operator */
pre.pygments .tok-ch { color: #0099FF; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #0099FF; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #009999 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #0099FF; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #0099FF; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #0099FF; font-weight: bold; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { background-color: #FFCCCC; border: 1px solid #CC0000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #FF0000 } /* Generic.Error */
pre.pygments .tok-gh { color: #003300; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { background-color: #CCFFCC; border: 1px solid #00CC00 } /* Generic.Inserted */
pre.pygments .tok-go { color: #AAAAAA } /* Generic.Output */
pre.pygments .tok-gp { color: #000099; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #003300; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #99CC66 } /* Generic.Traceback */
pre.pygments .tok-kc { color: #006699; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #006699; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #006699; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #006699 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #006699; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #007788; font-weight: bold } /* Keyword.Type */
pre.pygments .tok-m { color: #FF6600 } /* Literal.Number */
pre.pygments .tok-s { color: #CC3300 } /* Literal.String */
pre.pygments .tok-na { color: #330099 } /* Name.Attribute */
pre.pygments .tok-nb { color: #336666 } /* Name.Builtin */
pre.pygments .tok-nc { color: #00AA88; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #336600 } /* Name.Constant */
pre.pygments .tok-nd { color: #9999FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #CC0000; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #CC00FF } /* Name.Function */
pre.pygments .tok-nl { color: #9999FF } /* Name.Label */
pre.pygments .tok-nn { color: #00CCFF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #330099; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #003333 } /* Name.Variable */
pre.pygments .tok-ow { color: #000000; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #FF6600 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #FF6600 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #FF6600 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #FF6600 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #FF6600 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #CC3300 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #CC3300 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #CC3300 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #CC3300 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #CC3300; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #CC3300 } /* Literal.String.Double */
pre.pygments .tok-se { color: #CC3300; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #CC3300 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #AA0000 } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #CC3300 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #33AAAA } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #CC3300 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #FFCC33 } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #336666 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #CC00FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #003333 } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #003333 } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #003333 } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #003333 } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #FF6600 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="book">
<div id="header">
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<style>
body {
  max-width: 800px;
  margin: auto;
  font-family: sans-serif;
  // font-size: 18px;
}

#preamble .sectionbody .paragraph p {
  // font-size: 18px;
}

// h1 { font-size: 32px; margin-top: 4em; }
// h2 { font-size: 26px; margin-top: 2em; }
// h3 { font-size: 22px; margin-top: 2em; }


h1, h2, h3, h4, h5 {
  color: hsl(219, 50%, 50%);
  font-family: sans-serif;
  font-weight: bold;
}

.imageblock .title {
  font-family: sans-serif;
}

.sect1 { border-top-width: 0px; }

body > .sourceCode {
  padding: 5px;
  border-radius: 5px;
  border: 1px solid hsl(44, 7%, 80%);
  background-color: hsl(44, 7%, 96%);
}
</style>
</div>
</div>
<h1 id="_cn_tutorial" class="sect0">CN tutorial</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>CN is a type system for verifying C code, focusing especially on low-level systems code. Compared to the normal C type system, CN checks not only that expressions and statements follow the correct typing discipline for C-types, but also that the C code executes <em>safely</em> — does not raise C undefined behaviour — and <em>correctly</em> — according to strong user-defined specifications. To accurately handle the complex semantics of C, CN builds on the <a href="https://github.com/rems-project/cerberus/">Cerberus semantics for C</a>.</p>
</div>
<div class="paragraph">
<p>This tutorial introduces CN along a series of examples, starting with basic usage of CN on simple arithmetic functions and slowly moving towards more elaborate separation logic specifications of data structures.</p>
</div>
<div class="paragraph">
<p>Many examples are taken from Arthur Charguéraud’s excellent <a href="https://softwarefoundations.cis.upenn.edu">Separation Logic Foundations</a>. These example have names starting with &#8220;slf&#8230;&#8203;&#8221;.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To fetch and install CN, check the Cerberus repository at <a href="https://github.com/rems-project/cerberus" class="bare">https://github.com/rems-project/cerberus</a> and follow the instructions in <a href="https://github.com/rems-project/cerberus/blob/master/backend/cn/INSTALL.md">backend/cn/INSTALL.md</a>.</p>
</div>
<div class="paragraph">
<p>Once completed, type <code>cn --help</code> in your terminal to ensure CN is installed and found by your system. This should print the list of available options CN can be executed with.</p>
</div>
<div class="paragraph">
<p>To apply CN to a C file, run <code>cn CFILE</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_usage">Basic usage</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_first_example">First example</h3>
<div class="paragraph">
<p>For a first example, let’s look at a simple arithmetic function: <code>add</code>, shown below, takes two <code>int</code> arguments, <code>x</code> and <code>y</code>, and returns their sum.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">add</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">x</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">x</span><span class="tok-o">+</span><span class="tok-n">y</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Running CN on the example produces an error message:</p>
</div>
<div class="literalblock">
<div class="content">
<pre class="nowrap">cn exercises/0.c
[1/1]: add
exercises/0.c:3:10: error: Undefined behaviour
  return x+y;
         ~^~
an exceptional condition occurs during the evaluation of an expression (§6.5#5)
Consider the state in /var/folders/_v/ndl32wpj4bb3y9dg11rvc8ph0000gn/T/state_393431.html</pre>
</div>
</div>
<div class="paragraph">
<p>CN rejects the program because it has <em>C undefined behaviour</em>, meaning it is not safe to execute. CN points to the relevant source location, the addition <code>x+y</code>, and paragraph §6.5#5 of the C language standard that specifies the undefined behaviour. It also puts a link to an HTML file with more details on the error to help in diagnosing the problem.</p>
</div>
<div class="paragraph">
<p>Inspecting this HTML report (as we do in a moment) gives us possible example values for <code>x</code> and <code>y</code> that cause the undefined behaviour and hint at the problem: for very large values for <code>x</code> and <code>y</code>, such as <code>1073741825</code> and <code>1073741824</code>, the sum of <code>x</code> and <code>y</code> can exceed the representable range of a C <code>int</code> value: <code>1073741825 + 1073741824 = 2^31+1</code>, so their sum is larger than the maximal <code>int</code> value, <code>2^31-1</code>.</p>
</div>
<div class="paragraph">
<p>Here <code>x</code> and <code>y</code> are <em>signed integers</em>, and in C, signed integer <em>overflow</em> is undefined behaviour (UB). Hence, <code>add</code> is only safe to execute for smaller values. Similarly, <em>large negative</em> values of <code>x</code> and <code>y</code> can cause signed integer <em>underflow</em>, also UB in C. We therefore need to rule out too large values for <code>x</code> and <code>y</code>, both positive and negative, which we do by writing a CN function specification.</p>
</div>
</div>
<div class="sect2">
<h3 id="_first_function_specification">First function specification</h3>
<div class="paragraph">
<p>Shown below is our first function specification, for <code>add</code>, with a precondition that constraints <code>x</code> and <code>y</code> such that the sum of <code>x</code> and <code>y</code> lies between <code>-2147483648</code> and <code>2147483647</code>, so within the representable range of a C <code>int</code> value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">add</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">x</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-cm">/*@ requires let sum = (i64) x + (i64) y;</span>
<span class="tok-cm">             -2147483648i64 &lt;= sum; sum &lt;= 2147483647i64 @*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">x</span><span class="tok-o">+</span><span class="tok-n">y</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In detail:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Function specification are given using special <code>/*@ ... @*/</code> comments, placed in-between the function argument list and the function body.</p>
</li>
<li>
<p>The keyword <code>requires</code> starts the precondition, a list of one or more CN conditions separated by semicolons.</p>
</li>
<li>
<p>In function specifications, the names of the function arguments, here <code>x</code> and <code>y</code>, refer to their <em>initial values</em>. (Function arguments are mutable in C.)</p>
</li>
<li>
<p><code>let sum = (i64) x + (i64) y</code> is a let-binding, which defines <code>sum</code> as the value <code>(i64) x + (i64) y</code> in the remainder of the function specification.</p>
</li>
<li>
<p>Instead of C syntax, CN uses Rust-like syntax for integer types, such as <code>u32</code> for 32-bit unsigned integers and <code>i64</code> for signed 64-bit integers to make their sizes unambiguous. Here, <code>x</code> and <code>y</code>, of C-type <code>int</code>, have CN type <code>i32</code>.</p>
</li>
<li>
<p>To define <code>sum</code> we cast <code>x</code> and <code>y</code> to the larger <code>i64</code> type, using syntax <code>(i64)</code>, which is large enough to hold the sum of any two <code>i32</code> values.</p>
</li>
<li>
<p>Finally, we require this sum to be in-between the minimal and maximal <code>int</code> value. Integer constants, such as <code>-2147483648i64</code>, must specifiy their CN type (<code>i64</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Running CN on the annotated program passes without errors. This means with our specified precondition, <code>add</code> is safe to execute.</p>
</div>
<div class="paragraph">
<p>We may, however, wish to be more precise. So far the specification gives no information to callers of <code>add</code> about its output. To also specify the return values we add a postcondition, using the <code>ensures</code> keyword.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">add</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">x</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-cm">/*@ requires let sum = (i64) x + (i64) y;</span>
<span class="tok-cm">             -2147483648i64 &lt;= sum; sum &lt;= 2147483647i64 </span>
<span class="tok-cm">    ensures return == (i32) sum</span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">x</span><span class="tok-o">+</span><span class="tok-n">y</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we use the keyword <code>return</code>, only available in function postconditions, to refer to the return value, and equate it to <code>sum</code> as defined in the preconditions, cast back to <code>i32</code> type: <code>add</code> returns the sum of <code>x</code> and <code>y</code>.</p>
</div>
<div class="paragraph">
<p>Running CN confirms that this postcondition also holds.</p>
</div>
</div>
<div class="sect2">
<h3 id="_error_reports">Error reports</h3>
<div class="paragraph">
<p>In the original example CN reported a type error due to C undefined behaviour. While that example was perhaps simple enough to guess the problem and solution, this can become quite challenging as program and specification complexity increases. Diagnosing type errors is therefore an important part of using CN. CN tries to help with that by producting detailed error information, in the form of an HTML error report.</p>
</div>
<div class="paragraph">
<p>Let’s return to the type error from earlier (<code>add</code> without precondition) and take a closer look at this report. The report comprises two sections.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/0.error.png" alt="*CN error report*">
</div>
<div class="title">Figure 1. <strong>CN error report</strong></div>
</div>
<div class="paragraph">
<p><strong>Path.</strong> The first section, &#8220;Path to error&#8221;, contains information about the control-flow path leading to the error.</p>
</div>
<div class="paragraph">
<p>When type checking a C function, CN checks each possible control-flow path through the program individually. If CN detects UB or a violation of user-defined specifications, CN reports the problematic control-flow path, as a nested structure of statements: paths are split into sections, which group together statements between high-level control-flow positions (e.g. function entry, the start of a loop, the invocation of a <code>continue</code>, <code>break</code>, or <code>return</code> statement, etc.); within each section, statements are listed by source code location; finally, per statement, CN lists the typechecked sub-expressions, and the memory accesses and function calls within these.</p>
</div>
<div class="paragraph">
<p>In our example, there is only one possible control-flow path: entering the function body (section &#8220;function body&#8221;) and executing the block from lines 2 to 4, followed by the return statement at line 3. The entry for the latter contains the sequence of sub-expressions in the return statement, including reads of the variables <code>x</code> and <code>y</code>.</p>
</div>
<div class="paragraph">
<p>In C, local variables in a function, including its arguments, are mutable and their address can be taken and passed as a value. CN therefore represents local variables as memory allocations that are manipulated using memory reads and writes. Here, type checking the return statement includes checking memory reads for <code>x</code> and <code>y</code>, at their locations <code>&amp;ARG0</code> and <code>&amp;ARG1</code>. The path report lists these reads and their return values: the read at <code>&amp;ARG0</code> returns <code>x</code> (that is, the value of <code>x</code> originally passed to <code>add</code>); the read at <code>&amp;ARG1</code> returns <code>y</code>. Alongside this symbolic information, CN displays concrete values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>1073741825i32 /* 0x40000001 */</code> for x (the first value is the decimal representation, the second, in <code>/*...*/</code> comments, the hex equivalent) and</p>
</li>
<li>
<p><code>1073741824i32 /* 0x40000000 */</code> for <code>y</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For now, ignore the pointer values <code>{@0; 4}</code> for <code>x</code> and <code>{@0; 0}</code> for <code>y</code>.</p>
</div>
<div class="paragraph">
<p>These concrete values are part of a <em>counterexample</em>: a concrete valuation of variables and pointers in the program that that leads to the error. (The exact values may vary on your machine, depending on the version of Z3 installed on your system.)</p>
</div>
<div class="paragraph">
<p><strong>Proof context.</strong> The second section, below the error trace, lists the proof context CN has reached along this control-flow path.</p>
</div>
<div class="paragraph">
<p>&#8220;Available resources&#8221; lists the owned resources, as discussed in later sections.</p>
</div>
<div class="paragraph">
<p>&#8220;Variables&#8221; lists counterexample values for program variables and pointers. In addition to <code>x</code> and <code>y</code>, assigned the same values as above, this includes values for their memory locations <code>&amp;ARG0</code> and <code>&amp;ARG1</code>, function pointers in scope, and the <code>__cn_alloc_history</code>, all of which we ignore for now.</p>
</div>
<div class="paragraph">
<p>Finally, &#8220;Constraints&#8221; records all logical facts CN has learned along the path. This includes user-specified assumptions from preconditions or loop invariants, value ranges inferred from the C-types of variables, and facts learned during the type checking of the statements. Here (<code>add</code> without precondition) the only constraints are some contraints inferred from C-types in the code.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For instance, <code>good&lt;signed int&gt;(x)</code> says that the initial value of <code>x</code> is a &#8220;good&#8221; <code>signed int</code> value (i.e. in range). Here <code>signed int</code> is the same type as <code>int</code>, CN just makes the sign explicit. For integer types <code>T</code>, <code>good&lt;T&gt;</code> requires the value to be in range of type <code>T</code>; for pointer types <code>T</code> it also requires the pointer to be aligned. For structs and arrays this extends in the obvious way to struct members or array cells.</p>
</li>
<li>
<p><code>repr&lt;T&gt;</code> requires representability (not alignment) at type <code>T</code>, so <code>repr&lt;signed int*&gt;(&amp;ARGO)</code>, for instance, records that the pointer to <code>x</code> is representable at C-type <code>signed int*</code>;</p>
</li>
<li>
<p><code>aligned(&amp;ARGO, 4u64)</code>, moreover, states that it is 4-byte aligned.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_another_arithmetic_example">Another arithmetic example</h3>
<div class="paragraph">
<p>Let’s apply what we know so far to another simple arithmetic example.</p>
</div>
<div class="paragraph">
<p>The function <code>doubled</code>, shown below, takes an int <code>n</code>, defines <code>a</code> as <code>n</code> incremented, <code>b</code> as <code>n</code> decremented, and returns the sum of the two.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">doubled</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">a</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">b</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-mi">-1</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">a</span><span class="tok-o">+</span><span class="tok-n">b</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We would like to verify this is safe, and that <code>doubled</code> returns twice the value of <code>n</code>. Running CN on <code>doubled</code> leads to a type error: the increment of <code>a</code> has undefined behaviour.</p>
</div>
<div class="paragraph">
<p>As in the first example, we need to ensure that <code>n+1</code> does not overflow and <code>n-1</code> does not underflow. Similarly also <code>a+b</code> has to be representable at <code>int</code> type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">doubled</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-cm">/*@ requires let n_ = (i64) n;</span>
<span class="tok-cm">             -2147483648i64 &lt;= n_ - 1i64; n_ + 1i64 &lt;= 2147483647i64;</span>
<span class="tok-cm">             -2147483648i64 &lt;= n_ + n_; n_ + n_ &lt;= 2147483647i64</span>
<span class="tok-cm">    ensures return == n * 2i32</span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">a</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">b</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-mi">-1</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">a</span><span class="tok-o">+</span><span class="tok-n">b</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can specify these using a similar style of precondition as in the first example. We first define <code>n_</code> as <code>n</code> cast to type <code>i64</code> — i.e. a type large enough to hold <code>n+1</code>, <code>n-1</code> and <code>a+b</code> for any possible <code>i32</code> value for <code>n</code>. Then we specify that decrementing <code>n_</code> does not go below the minimal <code>int</code> value, that incrementing <code>n_</code> does not go above the maximal value, and that <code>n</code> doubled is also in range. These preconditions together guarantee safe execution.</p>
</div>
<div class="paragraph">
<p>To capture the functional behaviour, the postcondition specifies that <code>return</code> is twice the value of <code>n</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exercise">Exercise</h3>
<div class="paragraph">
<p><strong>Quadruple.</strong> Specify the precondition needed to ensure safety of the C function <code>quadruple</code>, and a postcondition that describes its return value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">quadruple</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Abs.</strong> Give a specification to the C function <code>abs</code>, which computes the absolute value of a given <code>int</code> value. To describe the return value, use CN’s ternary &#8220;_ ? _ : _&#8221; operator. Given a boolean <code>b</code>, and expressions <code>e1</code> and <code>e2</code> of the same basetype, <code>b ? e1 : e2</code> returns <code>e1</code> if <code>b</code> holds and <code>e2</code> otherwise.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">abs</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">x</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-w"> </span><span class="tok-o">&gt;=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">x</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-n">x</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pointers_and_simple_ownership">Pointers and simple ownership</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far we’ve only considered example functions manipulating integer values. Verification becomes more interesting and challenging when <em>pointers</em> are involved, because the safety of memory accesses via pointers has to be verified.</p>
</div>
<div class="paragraph">
<p>CN uses <em>separation logic resource types</em> and the concept of <em>ownership</em> to reason about memory accesses. A resource is the permission to access a region of memory. Unlike logical constraints, resource ownership is <em>unique</em>, meaning resources cannot be duplicated.</p>
</div>
<div class="paragraph">
<p>Let’s look at a simple example. The function <code>read</code> takes an <code>int</code> pointer <code>p</code> and returns the pointee value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">read</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Running CN on this example produces the following error:</p>
</div>
<div class="literalblock">
<div class="content">
<pre class="nowrap">cn exercises/read.c
[1/1]: read
exercises/read.c:3:10: error: Missing resource for reading
  return *p;
         ^~
Resource needed: Owned&lt;signed int&gt;(p)
Consider the state in /var/folders/_v/ndl32wpj4bb3y9dg11rvc8ph0000gn/T/state_403624.html</pre>
</div>
</div>
<div class="paragraph">
<p>For the read <code>*p</code> to be safe, ownership of a resource is missing: a resource <code>Owned&lt;signed int&gt;(p)</code>.</p>
</div>
<div class="sect2">
<h3 id="_the_owned_resource_type">The Owned resource type</h3>
<div class="paragraph">
<p>Given a C-type <code>T</code> and pointer <code>p</code>, the resource <code>Owned&lt;T&gt;(p)</code> asserts ownership of a memory cell at location <code>p</code> of the size of C-type <code>T</code>. It is is CN’s equivalent of a points-to assertion in separation logic (indexed by C-types <code>T</code>).</p>
</div>
<div class="paragraph">
<p>In this example we can ensure the safe execution of <code>read</code> by adding a precondition that requires ownership of <code>Owned&lt;int&gt;(p)</code>, as shown below. For now ignore the notation <code>take ... = Owned&lt;int&gt;(p)</code>. Since <code>read</code> maintains this ownership, we also add a corresponding postcondition, whereby <code>read</code> returns ownership of <code>p</code> after it is finished executing, in the form of another <code>Owned&lt;int&gt;(p)</code> resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">read</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span>
<span class="tok-cm">/*@ requires take v1 = Owned&lt;int&gt;(p)</span>
<span class="tok-cm">    ensures take v2 = Owned&lt;int&gt;(p)</span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This specifications means that</p>
</div>
<div class="ulist">
<ul>
<li>
<p>any function calling <code>read</code> has to be able to provide a resource <code>Owned&lt;int&gt;(p)</code> to pass into <code>read</code>, and</p>
</li>
<li>
<p>the caller will receive back a resource <code>Owned&lt;int&gt;(p)</code> when <code>read</code> returns.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_resource_outputs">Resource outputs</h3>
<div class="paragraph">
<p>However, a caller of <code>read</code> may also wish to know that <code>read</code> actually returns the correct value, the pointee of <code>p</code>, and also that it does not change memory at location <code>p</code>. To phrase both we need a way to refer to the pointee of <code>p</code>.</p>
</div>
<div class="paragraph">
<p>In CN resources have <em>outputs</em>. Each resource outputs the information that can be derived from ownership of the resource. What information is returned is specific to the type of resource. A resource <code>Owned&lt;T&gt;(p)</code> (for some C-type <code>T</code>) outputs the <em>pointee value</em> of <code>p</code>, since that can be derived from the resource ownership: assume you have a pointer <code>p</code> and the associated ownership, then this uniquely determines the pointee value of <code>p</code>.</p>
</div>
<div class="paragraph">
<p>CN uses the <code>take</code>-notation seen in the example above to refer to the output of a resource, introducing a new name binding for the output. The precondition <code>take v1 = Owned&lt;int&gt;(p)</code> from the precondition does two things: (1) it assert ownership of resource <code>Owned&lt;int&gt;(p)</code>, and (2) it binds the name <code>v1</code> to the resource output, here the pointee value of <code>p</code> at the start of the function. Similarly, the postcondition introduces the name <code>v2</code> for the pointee value on function return.</p>
</div>
<div class="paragraph">
<p>That means we can use the resource outputs from the pre- and postcondition to strengthen the specification of <code>read</code> as planned. We add two new postconditions: we specify</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>that <code>read</code> returns <code>v1</code> (the initial pointee value of <code>p</code>), and</p>
</li>
<li>
<p>that the pointee values <code>v1</code> and <code>v2</code> before and after execution of <code>read</code> (respectively) are the same.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">read</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span>
<span class="tok-cm">/*@ requires take v1 = Owned&lt;int&gt;(p)</span>
<span class="tok-cm">    ensures take v2 = Owned&lt;int&gt;(p);</span>
<span class="tok-cm">            return == v1;</span>
<span class="tok-cm">            v1 == v2</span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Aside.</strong> In standard separation logic the equivalent specification for <code>read</code> could have been phrased as follows (where <code>return</code> binds the return value in the postcondition):</p>
</div>
<div class="literalblock">
<div class="content">
<pre class="nowrap">∀p.
∀v1. { p ↦ v1 }
     read(p)
     { return. ∃v2. (p ↦ v2) /\ return = v1 /\ v1 = v2 }</pre>
</div>
</div>
<div class="paragraph">
<p>CN’s <code>take</code> notation is just alternative syntax for quantification over the values of resources, but a useful one: the <code>take</code> notation syntactically restricts how these quantifiers can be used to ensure CN can always infer them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exercises">Exercises</h3>
<div class="paragraph">
<p><strong>Quadruple</strong>. Specify the function <code>quadruple_mem</code>, that is similar to the earlier <code>quadruple</code> function, except that the input is passed as an <code>int</code> pointer. Write a specification that takes ownership of this pointer on entry and returns this ownership on exit, leaving the pointee value unchanged.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">quadruple_mem</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Abs</strong>. Give a specification to the function <code>abs_mem</code>, which computes the absolute value of a number passed as an <code>int</code> pointer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">abs_mem</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">x</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-w"> </span><span class="tok-o">&gt;=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">x</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-n">x</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_linear_resource_ownership">Linear resource ownership</h3>
<div class="paragraph">
<p>In the specifications we have written so far, functions that receive resources as part of their precondition also return this ownership in their postcondition.</p>
</div>
<div class="paragraph">
<p>Let’s try the <code>read</code> example from earlier again, but with a postcondition that does not return the ownership:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">read</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span>
<span class="tok-cm">/*@ requires take v1 = Owned&lt;int&gt;(p) @*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>CN rejects this program with the following message:</p>
</div>
<div class="literalblock">
<div class="content">
<pre class="nowrap">cn build/exercises/read.broken.c
[1/1]: read
build/exercises/read.broken.c:4:3: error: Left-over unused resource 'Owned&lt;signed int&gt;(p)(v1)'
  return *p;
  ^~~~~~~~~~
Consider the state in /var/folders/_v/ndl32wpj4bb3y9dg11rvc8ph0000gn/T/state_17eb4a.html</pre>
</div>
</div>
<div class="paragraph">
<p>CN has typechecked the function, verified that it is safe to execute under the precondition (given ownership <code>Owned&lt;int&gt;(p)</code>), and that the function (vacuously) satisfies its postcondition. But, following the check of the postcondition it finds that not all resources have been &#8220;used up&#8221;.</p>
</div>
<div class="paragraph">
<p>Given the above specification, <code>read</code> leaks memory: it takes ownership, does not return it, but also does not deallocate the owned memory or otherwise dispose of it. In CN this is a type error.</p>
</div>
<div class="paragraph">
<p>CN’s resource types are <em>linear</em> (as opposed to affine). This means not only that resources cannot be duplicated, but also that resources cannot simply be dropped or &#8220;forgotten&#8221;. Every resource passed into a function has to either be used up by it, by returning it or passing it to another function that consumes it, or destroyed, by deallocating the owned area of memory (as we shall see later).</p>
</div>
<div class="paragraph">
<p>CN’s motivation for linear tracking of resources is its focus on low-level systems software. CN checks C programs, in which, unlike higher-level garbage-collected languages, memory is managed manually, and memory leaks are typically very undesirable.</p>
</div>
<div class="paragraph">
<p>As a consequence, function specifications have to do precise &#8220;book-keeping&#8221; of their resource footprint, and, in particular, return any unused resources back to the caller.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_block_resource_type">The Block resource type</h3>
<div class="paragraph">
<p>Aside from the <code>Owned</code> resource seen so far, CN has another built-in resource type: <code>Block</code>. Given a C-type <code>T</code> and pointer <code>p</code>, <code>Block&lt;T&gt;(p)</code> asserts the same ownership as <code>Owned&lt;T&gt;(p)</code> — so ownership of a memory cell at <code>p</code> the size of type <code>T</code> — but in contrast to <code>Owned</code>, <code>Block</code> memory is not necessarily initialised.</p>
</div>
<div class="paragraph">
<p>CN uses this distinction to prevent reads from uninitialised memory:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A read at C-type <code>T</code> and pointer <code>p</code> requires a resource <code>Owned&lt;T&gt;(p)</code>, i.e., ownership of <em>initialised</em> memory at the right C-type. The load returns the <code>Owned</code> resource unchanged.</p>
</li>
<li>
<p>A write at C-type <code>T</code> and pointer <code>p</code> needs only a <code>Block&lt;T&gt;(p)</code> (so, unlike reads, writes to uninitialised memory are fine). The write consumes ownership of the <code>Block</code> resource (it destroys it) and returns a new resource <code>Owned&lt;T&gt;(p)</code> with the value written as the output. This means the resource returned from a write records the fact that this memory cell is now initialised and can be read from.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Since <code>Owned</code> carries the same ownership as <code>Block</code>, just with the additional information that the <code>Owned</code> memory is initalised, a resource <code>Owned&lt;T&gt;(p)</code> is &#8220;at least as good&#8221; as <code>Block&lt;T&gt;(p)</code> — an <code>Owned&lt;T&gt;(p)</code> resource can be used whenever <code>Block&lt;T&gt;(p)</code> is needed. For instance CN’s type checking of a write to <code>p</code> requires a <code>Block&lt;T&gt;(p)</code>, but if an <code>Owned&lt;T&gt;(p)</code> resource is what is available, this can be used just the same. This allows an already-initialised memory cell to be over-written again.</p>
</div>
<div class="paragraph">
<p>Unlike <code>Owned</code>, whose output is the pointee value, <code>Block</code> has no meaningful output: its output is <code>void</code>/<code>unit</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_write_example">Write example</h3>
<div class="paragraph">
<p>Let’s explore resources and their outputs in another example. The C function <code>incr</code> takes an <code>int</code> pointer <code>p</code> and increments the pointee value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">incr</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span>
<span class="tok-cm">/*@ requires take v1 = Owned&lt;int&gt;(p);</span>
<span class="tok-cm">             ((i64) v1) + 1i64 &lt;= 2147483647i64</span>
<span class="tok-cm">    ensures take v2 = Owned&lt;int&gt;(p);</span>
<span class="tok-cm">            v2 == v1+1i32 @*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the precondition we assert ownership of resource <code>Owned&lt;int&gt;(p)</code>, binding its output/pointee value to <code>v1</code>, and use <code>v1</code> to specify that <code>p</code> must point to a sufficiently small value at the start of the function not to overflow when incremented. The postcondition asserts ownership of <code>p</code> with output <code>v2</code>, as before, and uses this to express that the value <code>p</code> points to is incremented by <code>incr</code>: <code>v2 == v1+1i32</code>.</p>
</div>
<div class="paragraph">
<p>If we incorrectly tweaked this specification and used <code>Block&lt;int&gt;(p)</code> instead of <code>Owned&lt;int&gt;(p)</code> in the precondition, as below, then CN would reject the program.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">incr</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span>
<span class="tok-cm">/*@ requires take u = Block&lt;int&gt;(p)</span>
<span class="tok-cm">    ensures take v = Owned&lt;int&gt;(p) </span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>CN reports:</p>
</div>
<div class="literalblock">
<div class="content">
<pre class="nowrap">build/solutions/slf0_basic_incr.signed.broken.c:6:11: error: Missing resource for reading
  int n = *p;
          ^~
Resource needed: Owned&lt;signed int&gt;(p)
Consider the state in /var/folders/_v/ndl32wpj4bb3y9dg11rvc8ph0000gn/T/state_5da0f3.html</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Owned&lt;int&gt;(p)</code> resource required for reading is missing, since, as per precondition, only <code>Block&lt;int&gt;(p)</code> is available. Checking the linked HTML file confirms this. Here the section &#8220;Available resources&#8221; lists all resource ownership at the point of the failure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Block&lt;signed int&gt;(p)(u)</code>, so ownership of uninitialised memory at location <code>p</code>; the output is a <code>void</code>/<code>unit</code> value <code>u</code> (specified in the second pair of parentheses)</p>
</li>
<li>
<p><code>Owned&lt;signed int*&gt;(&amp;ARG0)(p)</code>, the ownership of (initialised) memory at location <code>&amp;ARG0</code>, so the memory location where the first function argument is stored; its output is the pointer <code>p</code> (not to be confused with the pointee of <code>p</code>); and finally</p>
</li>
<li>
<p><code>__CN_Alloc(&amp;ARG0)(void)</code> is a resource that records allocation information for location <code>&amp;ARG0</code>; this is related to CN’s memory-object semantics, which we ignore for the moment.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_exercises_2">Exercises</h3>
<div class="paragraph">
<p><strong>Zero.</strong> Write a specification for the function <code>zero</code>, which takes a pointer to <em>uninitialised</em> memory and initialises it to <code>0</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">zero</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>In-place double.</strong> Give a specification for the function <code>inplace_double</code>, which takes an <code>int</code> pointer <code>p</code> and doubles the pointee value: specify the precondition needed to guarantee safe execution and a postcondition that captures the function’s behaviour.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">inplace_double</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_multiple_owned_pointers">Multiple owned pointers</h3>
<div class="paragraph">
<p>When functions manipulate multiple pointers, we can assert their ownership just like before. However (as in standard separation logic) pointer ownership is unique, so simultaneous ownership of <code>Owned</code> or <code>Block</code> resources for two pointers requires these pointers to be disjoint.</p>
</div>
<div class="paragraph">
<p>The following example shows the use of two <code>Owned</code> resources for accessing two different pointers: function <code>add</code> reads two <code>int</code> values in memory, at locations <code>p</code> and <code>q</code>, and returns their sum.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">add</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">)</span>
<span class="tok-cm">/*@ requires take m = Owned&lt;unsigned int&gt;(p);</span>
<span class="tok-cm">             take n = Owned&lt;unsigned int&gt;(q)</span>
<span class="tok-cm">    ensures take m2 = Owned&lt;unsigned int&gt;(p);</span>
<span class="tok-cm">            take n2 = Owned&lt;unsigned int&gt;(q);</span>
<span class="tok-cm">            m == m2 &amp;&amp; n == n2;</span>
<span class="tok-cm">            return == m + n</span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-o">+</span><span class="tok-n">n</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time we use C’s <code>unsigned int</code> type. In C, over- and underflow of unsigned integers is not undefined behaviour, so we do not need any special preconditions to rule this out. Instead, when an arithmetic operation at unsigned type goes outside the representable range, the value &#8220;wraps around&#8221;.</p>
</div>
<div class="paragraph">
<p>The CN variables <code>m</code> and <code>n</code> (resp. <code>m2</code> and <code>n2</code>) for the pointee values of <code>p</code> and <code>q</code> before (resp. after) the execution of <code>add</code> have CN basetype <code>u32</code>, so unsigned 32-bit integers, matching the C <code>unsigned int</code> type. Like C’s unsigned integer arithmetic, CN unsigned int values wrap around when exceeding the value range of the type.</p>
</div>
<div class="paragraph">
<p>Hence, the postcondition <code>return == m+n</code> holds also when the sum of <code>m</code> and <code>n</code> is greater than the maximal <code>unsigned int</code> value.</p>
</div>
<div class="paragraph">
<p>In the following we will sometimes use unsigned integer types to focus on specifying memory ownership, rather than the conditions necessary to show absence of C arithmetic undefined behaviour.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exercises_3">Exercises</h3>
<div class="paragraph">
<p><strong>Swap.</strong> Specify the function <code>swap</code>, which takes two owned <code>unsigned int</code> pointers and swaps their values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">swap</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Transfer.</strong> Write a specification for the function <code>transfer</code>, shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">transfer</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ownership_of_compound_objects">Ownership of compound objects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far all examples have worked with just integers and pointers, but larger programs typically also manipulate compound values, often represented using C struct types. Specifying functions manipulating structs works in much the same way as with basic types.</p>
</div>
<div class="paragraph">
<p>For instance, the following example uses a <code>struct</code> <code>point</code> to represent a point in two-dimensional space. The function <code>transpose</code> swaps a point’s <code>x</code> and <code>y</code> coordinates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-k">struct</span><span class="tok-w"> </span><span class="tok-nc">point</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">x</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-p">};</span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">transpose</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-k">struct</span><span class="tok-w"> </span><span class="tok-nc">point</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-cm">/*@ requires take s = Owned&lt;struct point&gt;(p)</span>
<span class="tok-cm">    ensures take s2 = Owned&lt;struct point&gt;(p);</span>
<span class="tok-cm">            s2.x == s.y;</span>
<span class="tok-cm">            s2.y == s.x</span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">temp_x</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">p</span><span class="tok-o">-&gt;</span><span class="tok-n">x</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">temp_y</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">p</span><span class="tok-o">-&gt;</span><span class="tok-n">y</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-n">p</span><span class="tok-o">-&gt;</span><span class="tok-n">x</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">temp_y</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-n">p</span><span class="tok-o">-&gt;</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">temp_x</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here the precondition asserts ownership for <code>p</code>, at type <code>struct point</code>; the output <code>s</code> is a value of CN type <code>struct point</code>, i.e. a record with members <code>i32</code> <code>x</code> and <code>i32</code> <code>y</code>. The postcondition similarly asserts ownership of <code>p</code>, with output <code>s2</code>, and asserts the coordinates have been swapped, by referring to the members of <code>s</code> and <code>s2</code> individually.</p>
</div>
<div class="sect2">
<h3 id="_compound_owned_and_block_resources">Compound Owned and Block resources</h3>
<div class="paragraph">
<p>While one might like to think of a struct as a single (compound) object that is manipulated as a whole, C permits more flexible struct manipulation: given a struct pointer, programmers can construct pointers to <em>individual struct members</em> and pass these as values, even to other functions.</p>
</div>
<div class="paragraph">
<p>CN therefore cannot treat resources for compound C types, such as structs, as primitive, indivisible units. Instead, <code>Owned&lt;T&gt;</code> and <code>Block&lt;T&gt;</code> are defined inductively in the structure of the C-type <code>T</code>.</p>
</div>
<div class="paragraph">
<p>For struct types <code>T</code>, the <code>Owned&lt;T&gt;</code> resource is defined as the collection of <code>Owned</code> resources for its members (as well as <code>Block</code> resources for any padding bytes in-between). The resource <code>Block&lt;T&gt;</code>, similarly, is made up of <code>Block</code> resources for all members (and padding bytes).</p>
</div>
<div class="paragraph">
<p>To handle code that manipulates pointers into parts of a struct object, CN can automatically decompose a struct resource into the member resources, and recompose it, as needed. The following example illustrates this.</p>
</div>
<div class="paragraph">
<p>Recall the function <code>zero</code> from our earlier exercise. It takes an <code>int</code> pointer to uninitialised memory, with <code>Block&lt;int&gt;</code> ownership, and initialises the value to zero, returning an <code>Owned&lt;int&gt;</code> resource with output <code>0</code>.</p>
</div>
<div class="paragraph">
<p>Now consider the function <code>init_point</code>, shown below, which takes a pointer <code>p</code> to a <code>struct point</code> and zero-initialises its members by calling <code>zero</code> twice, once with a pointer to struct member <code>x</code>, and once with a pointer to <code>y</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">zero</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-cm">/*@ requires take u = Block&lt;int&gt;(p)</span>
<span class="tok-cm">    ensures take v = Owned&lt;int&gt;(p);</span>
<span class="tok-cm">            v == 0i32 @*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-k">struct</span><span class="tok-w"> </span><span class="tok-nc">point</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">x</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-p">};</span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">init_point</span><span class="tok-p">(</span><span class="tok-k">struct</span><span class="tok-w"> </span><span class="tok-nc">point</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-cm">/*@ requires take s = Block&lt;struct point&gt;(p)</span>
<span class="tok-cm">    ensures take s2 = Owned&lt;struct point&gt;(p);</span>
<span class="tok-cm">            s2.x == 0i32;</span>
<span class="tok-cm">            s2.y == 0i32</span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">zero</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">p</span><span class="tok-o">-&gt;</span><span class="tok-n">x</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-n">zero</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">p</span><span class="tok-o">-&gt;</span><span class="tok-n">y</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As stated in its precondition, <code>init_point</code> receives ownership <code>Block&lt;struct point&gt;(p)</code>. The <code>zero</code> function, however, works on <code>int</code> pointers and requires <code>Block&lt;int&gt;</code> ownership.</p>
</div>
<div class="paragraph">
<p>CN can prove the calls to <code>zero</code> with <code>&amp;p-&gt;x</code> and <code>&amp;p-&gt;y</code> are safe because it decomposes the <code>Block&lt;struct point&gt;(p)</code> into two <code>Block&lt;int&gt;</code>, one for member <code>x</code>, one for member <code>y</code>. Later, the reverse happens: following the two calls to <code>zero</code>, as per <code>zero</code>’s precondition, <code>init_point</code> has ownership of two adjacent <code>Owned&lt;int&gt;</code> resources – ownership for the two struct member pointers, with the member now initialised. Since the postcondition of <code>init_point</code> requires ownership <code>Owned&lt;struct point&gt;(p)</code>, CN combines these back into a compound resource. The resulting <code>Owned&lt;point struct&gt;</code> resource has for an output the struct value <code>s2</code> that is composed of the zeroed member values for <code>x</code> and <code>y</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resource_inference">Resource inference</h3>
<div class="paragraph">
<p>To handle the required resource inference, CN &#8220;eagerly&#8221; decomposes all <code>struct</code> resources into resources for the struct members, and &#8220;lazily&#8221; re-composes them as needed.</p>
</div>
<div class="paragraph">
<p>We can see this if, for instance, we experimentally change the <code>transpose</code> example from above to force a type error. Let’s insert an <code>/*@ assert(false) @*/</code> CN assertion in the middle of the <code>transpose</code> function (more on CN assertions later), so we can inspect CN’s proof context shown in the error report.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-k">struct</span><span class="tok-w"> </span><span class="tok-nc">point</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">x</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-p">};</span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">transpose</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-k">struct</span><span class="tok-w"> </span><span class="tok-nc">point</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-cm">/*@ requires take s = Owned&lt;struct point&gt;(p)</span>
<span class="tok-cm">    ensures take s2 = Owned&lt;struct point&gt;(p);</span>
<span class="tok-cm">            s2.x == s.y;</span>
<span class="tok-cm">            s2.y == s.x</span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">temp_x</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">p</span><span class="tok-o">-&gt;</span><span class="tok-n">x</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">temp_y</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">p</span><span class="tok-o">-&gt;</span><span class="tok-n">y</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-cm">/*@ assert(false); @*/</span>
<span class="tok-w">  </span><span class="tok-n">p</span><span class="tok-o">-&gt;</span><span class="tok-n">x</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">temp_y</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-n">p</span><span class="tok-o">-&gt;</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">temp_x</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The precondition of <code>transpose</code> asserts ownership of an <code>Owned&lt;struct point&gt;(p)</code> resource. The error report now instead lists under &#8220;Available resources&#8221; two resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Owned&lt;signed int&gt;(member_shift&lt;point&gt;(p, x))</code> with output <code>s.x</code> and</p>
</li>
<li>
<p><code>Owned&lt;signed int&gt;(member_shift&lt;point&gt;(p, y))</code> with output <code>s.y</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here <code>member_shift&lt;s&gt;(p,m)</code> is the CN expression that constructs, from a <code>struct s</code> pointer <code>p</code>, the &#8220;shifted&#8221; pointer for its member <code>m</code>.</p>
</div>
<div class="paragraph">
<p>When the function returns the two member resources are recombined &#8220;on demand&#8221; to satisfy the postcondition <code>Owned&lt;struct point&gt;(p)</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exercises_4">Exercises</h3>
<div class="paragraph">
<p><strong>Init point.</strong> Insert CN <code>assert(false)</code> statements in different statement positions of <code>init_point</code> and check how the available resources evolve.</p>
</div>
<div class="paragraph">
<p><strong>Transpose (again).</strong> Recreate the transpose function from before, now using the swap function verified earlier (for <code>struct upoint</code>, with unsigned member values).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">swap</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">)</span>
<span class="tok-cm">/*@ requires take v = Owned&lt;unsigned int&gt;(p);</span>
<span class="tok-cm">             take w = Owned&lt;unsigned int&gt;(q)</span>
<span class="tok-cm">    ensures  take v2 = Owned&lt;unsigned int&gt;(p);</span>
<span class="tok-cm">             take w2 = Owned&lt;unsigned int&gt;(q);</span>
<span class="tok-cm">             v2 == w &amp;&amp; w2 == v</span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">m</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-k">struct</span><span class="tok-w"> </span><span class="tok-nc">upoint</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">x</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-p">};</span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">transpose2</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-k">struct</span><span class="tok-w"> </span><span class="tok-nc">upoint</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_arrays_and_loops">Arrays and loops</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Another common datatype in C is arrays. Reasoning about memory ownership for arrays is more difficult than for the datatypes we have seen so far: C allows the programmer to access arrays using <em>computed pointers</em>, and the size of an array does not need to be known as a constant at compile time.</p>
</div>
<div class="paragraph">
<p>To support reasoning about code manipulating arrays and computed pointers, CN has <em>iterated resources</em>. For instance, to specify ownership of an <code>int</code> array with 10 cells starting at pointer <code>p</code>, CN uses the iterated resource</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-n">each</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">i32</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-n">i32</span><span class="tok-w"> </span><span class="tok-o">&lt;=</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-mi">10</span><span class="tok-n">i32</span><span class="tok-p">)</span>
<span class="tok-w">     </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">Owned</span><span class="tok-o">&lt;</span><span class="tok-kt">int</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">array_shift</span><span class="tok-o">&lt;</span><span class="tok-kt">int</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-n">i</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In detail, this can be read as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for each integer <code>i</code> of CN type <code>i32</code>, …</p>
</li>
<li>
<p>if <code>i</code> is between <code>0</code> and <code>10</code>, …</p>
</li>
<li>
<p>assert ownership of a resource <code>Owned&lt;int&gt;</code> …</p>
</li>
<li>
<p>for cell <code>i</code> of the array with base-address <code>p</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here <code>array_shift&lt;int&gt;(p,i)</code> computes a pointer into the array at pointer <code>p</code>, appropriately offset for index <code>i</code>.</p>
</div>
<div class="paragraph">
<p>In general, iterated resource specifications take the form</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-n">each</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">BT</span><span class="tok-w"> </span><span class="tok-n">Q</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">GUARD</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">RESOURCE</span><span class="tok-w"> </span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>comprising three parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BT Q</code>, for some CN type <code>BT</code> and name <code>Q</code>, introduces the quantifier <code>Q</code> of basetype <code>BT</code>, which is bound in <code>GUARD</code> and <code>RESOURCE</code>;</p>
</li>
<li>
<p><code>GUARD</code> is a boolean-typed expression delimiting the instances of <code>Q</code> for which ownership is asserted; and</p>
</li>
<li>
<p><code>RESOURCE</code> is any non-iterated CN resource.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_first_array_example">First array example</h3>
<div class="paragraph">
<p>Let’s see how this applies to a first example of an array-manipulating function. Function <code>read</code> takes three arguments: the base pointer <code>p</code> of an <code>int</code> array, the length <code>n</code> of the array, and an index <code>i</code> into the array; <code>read</code> then returns the value of the <code>i</code>-th array cell.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">read</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-p">)</span>
<span class="tok-cm">/*@ requires take a1 = each(i32 j; 0i32 &lt;= j &amp;&amp; j &lt; n) { Owned&lt;int&gt;(array_shift&lt;int&gt;(p,j)) };</span>
<span class="tok-cm">             0i32 &lt;= i &amp;&amp; i &lt; n</span>
<span class="tok-cm">    ensures take a2 = each(i32 j; 0i32 &lt;= j &amp;&amp; j &lt; n) { Owned&lt;int&gt;(array_shift&lt;int&gt;(p,j)) } @*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">p</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The CN precondition requires</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ownership of the array on entry — one <code>Owned&lt;int&gt;</code> resource for each array index between <code>0</code> and <code>n</code> — and</p>
</li>
<li>
<p>that <code>i</code> lies within the range of owned indices.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On exit the array ownership is returned again.</p>
</div>
<div class="paragraph">
<p>This specification, in principle, should ensure that the access <code>p[i]</code> is safe. However, running CN on the example produces an error: CN is unable to find the required ownership for reading <code>p[i]</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre class="nowrap">cn build/solutions/array_load.broken.c
[1/1]: read
build/solutions/array_load.broken.c:5:10: error: Missing resource for reading
  return p[i];
         ^~~~
Resource needed: Owned&lt;signed int&gt;(array_shift&lt;signed int&gt;(p, (u64)i))</pre>
</div>
</div>
<div class="paragraph">
<p>The reason is that when searching for a required resource, such as the <code>Owned</code> resource for <code>p[i]</code> here, CN’s resource inference does not consider iterated resources. Quantifiers, as used by iterated resources, can make verification undecidable, so, in order to maintain predictable type checking, CN delegates this aspect of the reasoning to the user.</p>
</div>
<div class="paragraph">
<p>To make the <code>Owned</code> resource required for accessing <code>p[i]</code> available to CN’s resource inference we have to &#8220;extract&#8221; ownership for index <code>i</code> out of the iterated resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">read</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-p">)</span>
<span class="tok-cm">/*@ requires take a1 = each(i32 j; 0i32 &lt;= j &amp;&amp; j &lt; n) { Owned&lt;int&gt;(array_shift&lt;int&gt;(p,j)) };</span>
<span class="tok-cm">             0i32 &lt;= i &amp;&amp; i &lt; n</span>
<span class="tok-cm">    ensures take a2 = each(i32 j; 0i32 &lt;= j &amp;&amp; j &lt; n) { Owned&lt;int&gt;(array_shift&lt;int&gt;(p,j)) } @*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-cm">/*@ extract Owned&lt;int&gt;, i; @*/</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">p</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here the CN comment <code>/*@ extract Owned&lt;int&gt;, i; @*/</code> is a CN &#8220;ghost statement&#8221;/proof hint that instructs CN to instantiate any available iterated <code>Owned&lt;int&gt;</code> resource for index <code>i</code>. In our example this operation splits the iterated resource into two:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-n">each</span><span class="tok-p">(</span><span class="tok-n">i32</span><span class="tok-w"> </span><span class="tok-n">j</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-n">i32</span><span class="tok-w"> </span><span class="tok-o">&lt;=</span><span class="tok-w"> </span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">Owned</span><span class="tok-o">&lt;</span><span class="tok-kt">int</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">array_shift</span><span class="tok-o">&lt;</span><span class="tok-kt">int</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-n">j</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>is split into</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the instantiation of the iterated resource at <code>i</code></p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-n">Owned</span><span class="tok-o">&lt;</span><span class="tok-kt">int</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">array_shift</span><span class="tok-o">&lt;</span><span class="tok-kt">int</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-n">i</span><span class="tok-p">))</span></code></pre>
</div>
</div>
</li>
<li>
<p>the remainder of the iterated resource, the ownership for all indices except <code>i</code></p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-n">each</span><span class="tok-p">(</span><span class="tok-n">i32</span><span class="tok-w"> </span><span class="tok-n">j</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-n">i32</span><span class="tok-w"> </span><span class="tok-o">&lt;=</span><span class="tok-w"> </span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">Owned</span><span class="tok-o">&lt;</span><span class="tok-kt">int</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">array_shift</span><span class="tok-o">&lt;</span><span class="tok-kt">int</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-n">j</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-p">}</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>After this extraction step, CN can use the (former) extracted resource to justify the access <code>p[i]</code>.</p>
</div>
<div class="paragraph">
<p>Following an <code>extract</code> statement, CN moreover remembers the extracted index and can automatically &#8220;reverse&#8221; the extraction when needed: after type checking the access <code>p[i]</code> CN must ensure the function’s postcondition holds, which needs the full array ownership again (including the extracted index <code>i</code>); remembering the index <code>i</code>, CN then automatically merges resources (1) and (2) again to obtain the required full array ownership, and completes the verification of the function.</p>
</div>
<div class="paragraph">
<p>So far the specification only guarantees safe execution but does not specify the behaviour of <code>read</code>. To address this, let’s return to the iterated resources in the function specification. When we specify <code>take a1 = each ...</code> here, what is <code>a1</code>? In CN, the output of an iterated resource is a <em>map</em> from indices to resource outputs. In this example, where index <code>j</code> has CN type <code>i32</code> and the iterated resource is <code>Owned&lt;int&gt;</code>, the output <code>a1</code> is a map from <code>i32</code> indices to <code>i32</code> values — CN type <code>map&lt;i32,i32&gt;</code>. (If the type of <code>j</code> was <code>i64</code> and the resource <code>Owned&lt;char&gt;</code>, <code>a1</code> would have type <code>map&lt;i64,u8&gt;</code>.)</p>
</div>
<div class="paragraph">
<p>We can use this to refine our specification with information about the functional behaviour of <code>read</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">read</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-p">)</span>
<span class="tok-cm">/*@ requires take a1 = each(i32 j; 0i32 &lt;= j &amp;&amp; j &lt; n) { Owned&lt;int&gt;(array_shift&lt;int&gt;(p,j)) };</span>
<span class="tok-cm">             0i32 &lt;= i &amp;&amp; i &lt; n</span>
<span class="tok-cm">    ensures take a2 = each(i32 j; 0i32 &lt;= j &amp;&amp; j &lt; n) { Owned&lt;int&gt;(array_shift&lt;int&gt;(p,j)) };</span>
<span class="tok-cm">            a1 == a2;</span>
<span class="tok-cm">            return == a1[i]</span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-cm">/*@ extract Owned&lt;int&gt;, i; @*/</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">p</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We specify that <code>read</code> does not change the array — the outputs <code>a1</code> and <code>a2</code>, before resp. after running the function, are the same — and that the value returned is <code>a1[i]</code>, <code>a1</code> at index <code>i</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exercises_5">Exercises</h3>
<div class="paragraph">
<p><strong>Array read two.</strong> Specify and verify the following function, <code>array_read_two</code>, which takes the base pointer <code>p</code> of an <code>unsigned int</code> array, the array length <code>n</code>, and two indices <code>i</code> and <code>j</code>. Assuming <code>i</code> and <code>j</code> are different, it returns the sum of the values at these two indices.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">array_read_two</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">j</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">tmp1</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">p</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">tmp2</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">p</span><span class="tok-p">[</span><span class="tok-n">j</span><span class="tok-p">];</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">tmp1</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">tmp2</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Swap array.</strong> Specify and verify <code>swap_array</code>, which swaps the values of two cells of an <code>int</code> array. Assume again that <code>i</code> and <code>j</code> are different, and describe the effect of <code>swap_array</code> on the array value using the CN map update expression <code>a[i:v]</code>, which denotes the same map as <code>a</code>, except with index <code>i</code> updated to <code>v</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">swap_array</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">j</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">tmp</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">p</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>
<span class="tok-w">  </span><span class="tok-n">p</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">p</span><span class="tok-p">[</span><span class="tok-n">j</span><span class="tok-p">];</span>
<span class="tok-w">  </span><span class="tok-n">p</span><span class="tok-p">[</span><span class="tok-n">j</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">tmp</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_loops">Loops</h3>
<div class="paragraph">
<p>The array examples covered so far manipulate one or two individual cells of an array. Another typical pattern in code working over arrays is to <strong>loop</strong>, uniformly accessing all cells of an array, or sub-ranges of it.</p>
</div>
<div class="paragraph">
<p>In order to verify code with loops, CN requires the user to supply loop invariants&#8201;&#8212;&#8201;CN specifications of all owned resources and the constraints required to verify each iteration of the loop.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at a simple first example. The following function, <code>init_array</code>, takes the base pointer <code>p</code> of a <code>char</code> array and the array length <code>n</code> and writes <code>0</code> to each array cell.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">init_array</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-cm">/*@ requires take a1 = each(u32 i; i &lt; n) { Owned&lt;char&gt;( array_shift&lt;char&gt;(p, i)) }</span>
<span class="tok-cm">    ensures  take a2 = each(u32 i; i &lt; n) { Owned&lt;char&gt;( array_shift&lt;char&gt;(p, i)) } </span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">)</span>
<span class="tok-w">  </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">p</span><span class="tok-p">[</span><span class="tok-n">j</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-n">j</span><span class="tok-o">++</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If, for the moment, we focus just on proving safe execution of <code>init_array</code>, ignoring its functional behaviour, a specification might look as above: on entry <code>init_array</code> takes ownership of an iterated <code>Owned&lt;char&gt;</code> resource&#8201;&#8212;&#8201;one <code>Owned</code> resource for each index <code>i</code> of type <code>u32</code> (so necessarily greater or equal to <code>0</code>) up to <code>n</code>; on exit <code>init_array</code> returns the ownership.</p>
</div>
<div class="paragraph">
<p>To verify this, we have to supply a loop invariant that specifies all resource ownership and the necessary constraints that hold before and after each iteration of the loop. Loop invariants are specified using the keyword <code>inv</code>, followed by CN specifications using the same syntax as in function pre- and postconditions. The variables in scope for loop invariants are all in-scope C variables, as well as CN variables introduced in the function precondition. <strong>In loop invariants, the name of a C variable refers to its current value</strong> (more on this shortly).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">init_array</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-cm">/*@ requires take a1 = each(u32 i; i &lt; n) { Owned&lt;char&gt;( array_shift&lt;char&gt;(p, i)) }</span>
<span class="tok-cm">    ensures  take a2 = each(u32 i; i &lt; n) { Owned&lt;char&gt;( array_shift&lt;char&gt;(p, i)) } </span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">)</span>
<span class="tok-w">  </span><span class="tok-cm">/*@ inv take ai = each(u32 i; i &lt; n) { Owned&lt;char&gt;( array_shift&lt;char&gt;(p, i)) };</span>
<span class="tok-cm">          {p} unchanged; {n} unchanged</span>
<span class="tok-cm">  @*/</span>
<span class="tok-w">  </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-cm">/*@ extract Owned&lt;char&gt;, j; @*/</span>
<span class="tok-w">    </span><span class="tok-n">p</span><span class="tok-p">[</span><span class="tok-n">j</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-n">j</span><span class="tok-o">++</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The main condition here is unsurprising: we specify ownership of an iterated resource for an array just like in the the pre- and postcondition.</p>
</div>
<div class="paragraph">
<p>The second thing we need to do, however, is less straightforward. Recall that, as discussed at the start of the tutorial, function arguments in C are mutable, and so CN permits this as well.While in this example it is obvious that <code>p</code> and <code>n</code> do not change, CN currently requires the loop invariant to explicitly state this, using special notation <code>{p} unchanged</code> (and similarly for <code>n</code>).</p>
</div>
<div class="paragraph">
<p><strong>Note.</strong> If we forget to specify <code>unchanged</code>, this can lead to confusing errors. In this example, for instance, CN would verify the loop against the loop invariant, but would be unable to prove a function postcondition seemingly directly implied by the loop invariant (lacking the information that the postcondition&#8217;s <code>p</code> and <code>n</code> are the same as the loop invariant&#8217;s). Future CN versions may handle loop invariants differently and treat variables as immutable by default.</p>
</div>
<div class="paragraph">
<p>The final piece needed in the verification is an <code>extract</code> statement, as used in the previous examples: to separate the individual <code>Owned&lt;char&gt;</code> resource for index <code>j</code> out of the iterated <code>Owned</code> resource and make it available to the resource inference, we specify <code>extract Owned&lt;char&gt;, j;</code>.</p>
</div>
<div class="paragraph">
<p>With the <code>extract</code> statements in place, CN accepts the function.</p>
</div>
</div>
<div class="sect2">
<h3 id="_second_loop_example">Second loop example</h3>
<div class="paragraph">
<p>However, on closer look, the specification of <code>init_array</code> is overly strong: it requires an iterated <code>Owned</code> resource for the array on entry. If, as the name suggests, the purpose of <code>init_array</code> is to initialise the array, then a precondition asserting only an iterated <code>Block</code> resource for the array should also be sufficient. The modified specification is then as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">init_array2</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-cm">/*@ requires take a1 = each(u32 i; i &lt; n) { Block&lt;char&gt;( array_shift&lt;char&gt;(p, i)) }</span>
<span class="tok-cm">    ensures  take a2 = each(u32 i; i &lt; n) { Owned&lt;char&gt;( array_shift&lt;char&gt;(p, i)) } </span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">)</span>
<span class="tok-w">  </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">p</span><span class="tok-p">[</span><span class="tok-n">j</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-n">j</span><span class="tok-o">++</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This specification <strong>should</strong> hold: assuming ownership of an uninitialised array on entry, each iteration of the loop initialises one cell of the array, moving it from <code>Block</code> to <code>Owned</code> &#8220;state&#8221;, so that on function return the full array is initialised. (Recall that stores only require <code>Block</code> ownership of the written memory location, so ownership of not-necessarily-initialised memory.)</p>
</div>
<div class="paragraph">
<p>To verify this modified example we again need a loop invariant. This time, the loop invariant is more involved, however: since each iteration of the loop initialises one more array cell, the loop invariant has to do precise book-keeping of the initialisation status of the array.</p>
</div>
<div class="paragraph">
<p>To do so, we partition the array ownership into two parts: for each index of the array the loop has already visited, we have an <code>Owned</code> resource, for all other array indices we have the (unchanged) <code>Block</code> ownership.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">init_array2</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-cm">/*@ requires take a1 = each(u32 i; i &lt; n) { Block&lt;char&gt;( array_shift&lt;char&gt;(p, i)) }</span>
<span class="tok-cm">    ensures  take a2 = each(u32 i; i &lt; n) { Owned&lt;char&gt;( array_shift&lt;char&gt;(p, i)) } </span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">)</span>
<span class="tok-w">  </span><span class="tok-cm">/*@ inv take al = each(u32 i; i &lt; j) { Owned&lt;char&gt;( array_shift&lt;char&gt;(p, i)) };</span>
<span class="tok-cm">          take ar = each(u32 i; j &lt;= i &amp;&amp; i &lt; n) { Block&lt;char&gt;( array_shift&lt;char&gt;(p, i)) };</span>
<span class="tok-cm">          {p} unchanged; {n} unchanged;</span>
<span class="tok-cm">          j &lt;= n</span>
<span class="tok-cm">  @*/</span>
<span class="tok-w">  </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-cm">/*@ extract Block&lt;char&gt;, j; @*/</span>
<span class="tok-w">    </span><span class="tok-cm">/*@ extract Owned&lt;char&gt;, j; @*/</span>
<span class="tok-w">    </span><span class="tok-n">p</span><span class="tok-p">[</span><span class="tok-n">j</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-n">j</span><span class="tok-o">++</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s go through this line-by-line:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We assert ownership of an iterated <code>Owned</code> resource, one for each index <code>i</code> strictly smaller than loop variable <code>j</code>.</p>
</li>
<li>
<p>All remaining indices <code>i</code>, between <code>j</code> and <code>n</code> are still uninitialised, so part of the iterated <code>Block</code> resource.</p>
</li>
<li>
<p>As in the previous example, we assert <code>p</code> and <code>n</code> are unchanged.</p>
</li>
<li>
<p>Finally, unlike in the previous example, this loop invariant involves <code>j</code>. We therefore also need to know that <code>j</code> does not exceed the array length <code>n</code>. Otherwise CN would not be able to prove that, on completing the last loop iteration, <code>j=n</code> holds. This, in turn, is needed to show that when the function returns, ownership of the iterated <code>Owned</code> resource --- as specified in the loop invariant --- is fully consumed by the function&#8217;s post-condition and there is no left-over unused resource.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As before, we also have to instruct CN to <code>extract</code> ownership of individual array cells out of the iterated resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>to allow CN to extract the individual <code>Block</code> to be written we use <code>extract Block&lt;char&gt;, j;</code>;</p>
</li>
<li>
<p>the store returns a matching <code>Owned&lt;char&gt;</code> resource for index <code>j</code>;</p>
</li>
<li>
<p>finally, we put <code>extract Owned&lt;char&gt;, j;</code> to allow CN to &#8220;attach&#8221; this resource to the iterated <code>Owned</code> resource. CN issues a warning, because nothing is, in fact, extracted: we are using <code>extract</code> only for the &#8220;reverse&#8221; direction.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_exercises_6">Exercises</h3>
<div class="paragraph">
<p><strong>Init array reverse.</strong> Verify the function <code>init_array_rev</code>, which has the same specification as <code>init_array2</code>, but reverses the array in decreasing index order (&#8220;from right to left&#8221;).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="c"><span></span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">init_array2</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">)</span><span class="tok-w"> </span>
<span class="tok-cm">/*@ requires take a1 = each(u32 i; i &lt; n) { Block&lt;char&gt;( array_shift&lt;char&gt;(p, i)) };</span>
<span class="tok-cm">    n &gt; 0u32</span>
<span class="tok-cm">    ensures  take a2 = each(u32 i; i &lt; n) { Owned&lt;char&gt;( array_shift&lt;char&gt;(p, i)) } </span>
<span class="tok-cm">@*/</span>
<span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">j</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">n</span><span class="tok-p">)</span>
<span class="tok-w">  </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">p</span><span class="tok-p">[</span><span class="tok-n">n</span><span class="tok-o">-</span><span class="tok-p">(</span><span class="tok-n">j</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">)]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-n">j</span><span class="tok-o">++</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>